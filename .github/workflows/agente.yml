name: ðŸ¤– Agente IA - Generar CÃ³digo desde Issue

on:
  issues:
    types: [opened]

jobs:
  generate-code:
    runs-on: ubuntu-latest

    permissions:
      contents: write   # commit al repo
      issues: write     # comentar el issue

    steps:
      # ---------------------------------------
      # Checkout
      # ---------------------------------------
      - name: ðŸ“¥ Checkout repositorio
        uses: actions/checkout@v4

      # ---------------------------------------
      # Python
      # ---------------------------------------
      - name: ðŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install openai

      # ---------------------------------------
      # ConfiguraciÃ³n declarativa del agente
      # ---------------------------------------
      - name: âš™ï¸ Configurar entorno del agente
        run: |
          echo "CODE_AGENT_PROVIDER=dummy" >> $GITHUB_ENV
          echo "CODE_AGENT_MODEL=gpt-4o-mini" >> $GITHUB_ENV
          echo "CODE_PROMPT_VERSION=v1" >> $GITHUB_ENV

      # ---------------------------------------
      # Ejecutar agente IA (orquestador)
      # ---------------------------------------
      - name: ðŸ¤– Ejecutar agente IA
        id: agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          FILES=$(python agents/orchestrator_agent.py \
            "${{ github.event.issue.title }}" \
            "${{ github.event.issue.body }}")

          echo "FILES<<EOF" >> $GITHUB_ENV
          echo "$FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ---------------------------------------
      # Commit automÃ¡tico (opcional)
      # ---------------------------------------
      #- name: ðŸ“¤ Commit y push de archivos generados
      #  run: |
      #    git config user.name "agentic-bot"
      #    git config user.email "agentic-bot@users.noreply.github.com"
      #
      #    git add .
      #    git commit -m "ðŸ¤– CÃ³digo generado por agente IA para issue #${{ github.event.issue.number }}" || echo "No changes to commit"
      #    git push

      # ---------------------------------------
      # Responder en el issue
      # ---------------------------------------
      - name: ðŸ’¬ Comentar resultado en el Issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "
          ## ðŸ¤– CÃ³digo generado automÃ¡ticamente

          **Stack solicitado**
          \`${{ github.event.issue.title }}\`

          **Historia de usuario**
          > ${{ github.event.issue.body }}

          **Archivos creados**
          \`\`\`
          ${{ env.FILES }}
          \`\`\`

          âœ… Los archivos fueron generados por el agente IA.
          "
